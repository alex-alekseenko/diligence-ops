# E2E Test: Results Report Display (MANDATORY)

Validates that the frontend correctly renders the full diligence report
using pre-saved example data from `examples/AAPL/`.

**Executed via:** Playwright MCP
**Data source:** `examples/AAPL/` (bronze/silver/gold CSVs + results memo)

## Prerequisites

1. Start mock API server (serves example data on port 8001):
   ```
   uv run python tests/e2e/mock_api_server.py 8001
   ```
2. Start frontend dev server (port 3000):
   ```
   cd frontend && bun run dev
   ```

## Playwright MCP Test Steps

### 1. Setup route interception + WebSocket stub

```js
// browser_run_code
async (page) => {
  await page.unrouteAll();
  await page.route('http://localhost:8000/**', async (route) => {
    const newUrl = route.request().url().replace('localhost:8000', 'localhost:8001');
    try {
      const response = await route.fetch({ url: newUrl });
      await route.fulfill({ response });
    } catch (e) { await route.abort(); }
  });
  await page.addInitScript(() => {
    window.WebSocket = function() {
      const fake = { readyState: 3, send(){}, close(){}, onclose: null };
      setTimeout(() => { if (fake.onclose) fake.onclose({}); }, 100);
      return fake;
    };
  });
  await page.goto('http://localhost:3000');
  await page.waitForLoadState('networkidle');
}
```

### 2. Trigger AAPL analysis

Click the "AAPL" quick-pick button.

### 3. Wait for results

```
Wait for text: "Deal Recommendation"
```

### 4. Validate results dashboard

Assert visible:
- **Deal Recommendation banner:** "DO NOT PROCEED"
- **Company header:** "Apple Inc. (AAPL)"
- **Confidence:** "100%"
- **KPI cards:** Revenue $416.2B, Net Income $112.0B, Gross Margin 46.9%, D/E Ratio 3.87

### 5. Click "Full Report" tab

### 6. Validate report content

Assert the rendered markdown contains all 10 sections:
- [ ] `Due Diligence Report: Apple Inc. (AAPL)` (title)
- [ ] `1. Executive Summary` with "DO_NOT_PROCEED"
- [ ] `2. Company Overview` with "$416 billion"
- [ ] `3. Financial Analysis` with "debt-to-equity ratio of 3.87"
- [ ] `4. Risk Factor Analysis`
- [ ] `5. Insider Trading Signals` with "Buys: 0, Sells: 30"
- [ ] `6. Institutional Ownership` with "VANGUARD GROUP INC"
- [ ] `7. Material Events` with 5 events listed
- [ ] `8. Governance & Compensation` with "CEO: Tim Cook"
- [ ] `9. Cross-Workstream Red Flags` with "[Critical] Non-Reliance on Financials"
- [ ] `10. Recommendation & Caveats` with "DO_NOT_PROCEED"
- [ ] `Key Findings` with 3 bullet points
- [ ] Footer: "Generated by DiligenceOps v0.3"

### 7. Click "Risk Analysis" tab

Assert visible:
- 5 risk dimensions (Financial Health, Market Position, Operational Risk, Governance, Liquidity)
- Composite score: "Medium (2.2/5.0)"
- Red flags: "High Leverage", "Low Current Ratio", "Moderate Revenue Growth"
- Cross-workstream flags: "Non-Reliance on Financials" (Critical), "Novel Regulatory Risk + Insider Selling" (High)

### 8. Screenshot

Save full-page screenshot to `tests/e2e/screenshots/results_report_fullpage.png`.

## Pass Criteria

All assertions in steps 4, 6, and 7 must pass. The report must render all 10 sections
with data matching the pre-saved example files in `examples/AAPL/`.
